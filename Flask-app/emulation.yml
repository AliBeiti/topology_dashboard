name: emulation

topology:
  nodes:
    switch_a:
      kind: ovs-bridge
    switch_b:
      kind: ovs-bridge
    switch_c:
      kind: ovs-bridge
    switch_d:
      kind: ovs-bridge

    R1:
      kind: linux
      image: frrouting/frr:v7.5.1
      binds:
        - daemons:/etc/frr/daemons
        - r1.conf:/etc/frr/frr.conf

    R2:
      kind: linux
      image: frrouting/frr:v7.5.1
      binds:
        - daemons:/etc/frr/daemons
        - r2.conf:/etc/frr/frr.conf

    serf1:
      kind: linux
      image: abdullahmuzlim279/k3s-serf-node:warmcache-test
      env:
        CLAB_LINUX_PRIVILEGED: "true"
      binds:
        - /sys/fs/cgroup:/sys/fs/cgroup:rw
        - /lib/modules:/lib/modules:ro
        - /dev:/dev
        - annotations/create_resources.py:/opt/annotations/create_resources.py:ro
        - annotations/emulation_config.json:/opt/annotations/emulation_config.json:ro
        - annotations/expose_metrics.py:/opt/annotations/expose_metrics.py:ro
        - annotations/replay_metrics.py:/opt/annotations/replay_metrics.py:ro
      ports:
        - 10091:9090
      cmd: >
          bash -c '
            set -e
            echo "[INIT] Preparing system..."
            ulimit -n 65536
            sysctl -w fs.inotify.max_user_instances=4096
            sysctl -w fs.inotify.max_user_watches=524288
            sysctl -w fs.file-max=2097152

            # Disable PSI reporting to avoid issues with cgroup enforcement
            echo 0 > /sys/fs/cgroup/cpu.pressure || true
            echo 0 > /sys/fs/cgroup/memory.pressure || true

            # Wait for eth1 to appear
            echo "[NET] Waiting for eth1 to be created..."
            until ip link show eth1 >/dev/null 2>&1; do
                sleep 1
            done
            echo "[NET] eth1 detected."

            # Set up network
            ip link set eth1 up
            # ip addr add 10.1.0.1/24 dev eth1
            ip link set eth1 mtu 1400

            # Small randomized delay
            sleep $((RANDOM % 10 + 5))

            # Start K3s (with cgroup enforcement disabled)
            echo "[INIT] Launching optimized K3s server with relaxed cgroups..."
            k3s server \
              --node-name serf1 \
              --disable traefik \
              --disable servicelb \
              --disable local-storage \
              --disable metrics-server \
              --disable-cloud-controller \
              --disable-network-policy \
              --disable-helm-controller \
              --snapshotter native \
              --tls-san 10.1.0.1 \
              --kubelet-arg=cgroup-root=/ \
              --kubelet-arg=cgroups-per-qos=false \
              --kubelet-arg=enforce-node-allocatable= \
              --v=0 &

            sleep 20
            chmod 666 /etc/rancher/k3s/k3s.yaml
            export KUBECONFIG=/etc/rancher/k3s/k3s.yaml

            echo "[INIT] Waiting for containerd to be ready..."
            until /usr/local/bin/k3s ctr version >/dev/null 2>&1; do
                echo "  containerd not yet ready, retrying..."
                sleep 3
            done
            echo "Containerd is ready."

            echo "[INIT] Importing cached images..."
            for f in /opt/k3s-images/*.tar; do
                echo "Loading $f ..."
                /usr/local/bin/k3s ctr images import "$f" || true
            done
            
            k3s kubectl apply -f /tmp/qos-controller-daemonset.yaml
            k3s kubectl apply -f /tmp/service-account.yaml
            k3s kubectl apply -f /tmp/cluster-role.yaml
            k3s kubectl apply -f /tmp/cluster-role-binding.yaml
            k3s kubectl apply -f /tmp/deployment-scheduler.yaml
            k3s kubectl apply -f /tmp/ram_price.yaml
            k3s kubectl apply -f /tmp/storage_price.yaml
            k3s kubectl apply -f /tmp/vcpu_price.yaml
            k3s kubectl apply -f /tmp/vgpu_price.yaml   

            mkdir -p ~/.kube
            cp /etc/rancher/k3s/k3s.yaml ~/.kube/config
            chown $(whoami):$(whoami) ~/.kube/config
            chmod 600 ~/.kube/config

            echo "[READY] K3s cluster is up and running on $(hostname)."

            # Install KWOK
            echo "[KWOK] Installing KWOK controller..."
            k3s kubectl apply -f https://github.com/kubernetes-sigs/kwok/releases/latest/download/kwok.yaml
            
            echo "[KWOK] Waiting for KWOK controller to be ready..."
            k3s kubectl -n kube-system rollout status deploy/kwok-controller --timeout=300s
            
            echo "[KWOK] Applying stage-fast configuration..."
            k3s kubectl apply -f https://github.com/kubernetes-sigs/kwok/releases/latest/download/stage-fast.yaml
            
            echo "[KWOK] Applying metrics-usage configuration..."
            k3s kubectl apply -f https://github.com/kubernetes-sigs/kwok/releases/latest/download/metrics-usage.yaml
            
            echo "[KWOK] Installation complete!"
            
            while true; do
                sync
                echo 3 > /proc/sys/vm/drop_caches
                sleep 100000
            done &

            sleep infinity
          '
    
    serf2:
      kind: linux
      image: abdullahmuzlim279/k3s-serf-node:warmcache-test
      env:
        CLAB_LINUX_PRIVILEGED: "true"
      binds:
        - /sys/fs/cgroup:/sys/fs/cgroup:rw
        - /lib/modules:/lib/modules:ro
        - /dev:/dev
        - annotations/create_resources.py:/opt/annotations/create_resources.py:ro
        - annotations/emulation_config.json:/opt/annotations/emulation_config.json:ro
        - annotations/expose_metrics.py:/opt/annotations/expose_metrics.py:ro
        - annotations/replay_metrics.py:/opt/annotations/replay_metrics.py:ro
      ports:
        - 10092:9090
      cmd: >
          bash -c '
            set -e
            echo "[INIT] Preparing system..."
            ulimit -n 65536
            sysctl -w fs.inotify.max_user_instances=4096
            sysctl -w fs.inotify.max_user_watches=524288
            sysctl -w fs.file-max=2097152

            # Disable PSI reporting to avoid issues with cgroup enforcement
            echo 0 > /sys/fs/cgroup/cpu.pressure || true
            echo 0 > /sys/fs/cgroup/memory.pressure || true

            # Wait for eth1 to appear
            echo "[NET] Waiting for eth1 to be created..."
            until ip link show eth1 >/dev/null 2>&1; do
                sleep 1
            done
            echo "[NET] eth1 detected."

            # Set up network
            ip link set eth1 up
            # ip addr add 10.1.0.1/24 dev eth1
            ip link set eth1 mtu 1400

            # Small randomized delay
            sleep $((RANDOM % 10 + 5))

            # Start K3s (with cgroup enforcement disabled)
            echo "[INIT] Launching optimized K3s server with relaxed cgroups..."
            k3s server \
              --node-name serf1 \
              --disable traefik \
              --disable servicelb \
              --disable local-storage \
              --disable metrics-server \
              --disable-cloud-controller \
              --disable-network-policy \
              --disable-helm-controller \
              --snapshotter native \
              --tls-san 10.1.0.1 \
              --kubelet-arg=cgroup-root=/ \
              --kubelet-arg=cgroups-per-qos=false \
              --kubelet-arg=enforce-node-allocatable= \
              --v=0 &

            sleep 20
            chmod 666 /etc/rancher/k3s/k3s.yaml
            export KUBECONFIG=/etc/rancher/k3s/k3s.yaml

            echo "[INIT] Waiting for containerd to be ready..."
            until /usr/local/bin/k3s ctr version >/dev/null 2>&1; do
                echo "  containerd not yet ready, retrying..."
                sleep 3
            done
            echo "Containerd is ready."

            echo "[INIT] Importing cached images..."
            for f in /opt/k3s-images/*.tar; do
                echo "Loading $f ..."
                /usr/local/bin/k3s ctr images import "$f" || true
            done
            
            k3s kubectl apply -f /tmp/qos-controller-daemonset.yaml
            k3s kubectl apply -f /tmp/service-account.yaml
            k3s kubectl apply -f /tmp/cluster-role.yaml
            k3s kubectl apply -f /tmp/cluster-role-binding.yaml
            k3s kubectl apply -f /tmp/deployment-scheduler.yaml
            k3s kubectl apply -f /tmp/ram_price.yaml
            k3s kubectl apply -f /tmp/storage_price.yaml
            k3s kubectl apply -f /tmp/vcpu_price.yaml
            k3s kubectl apply -f /tmp/vgpu_price.yaml   

            mkdir -p ~/.kube
            cp /etc/rancher/k3s/k3s.yaml ~/.kube/config
            chown $(whoami):$(whoami) ~/.kube/config
            chmod 600 ~/.kube/config

            echo "[READY] K3s cluster is up and running on $(hostname)."

            # Install KWOK
            echo "[KWOK] Installing KWOK controller..."
            k3s kubectl apply -f https://github.com/kubernetes-sigs/kwok/releases/latest/download/kwok.yaml
            
            echo "[KWOK] Waiting for KWOK controller to be ready..."
            k3s kubectl -n kube-system rollout status deploy/kwok-controller --timeout=300s
            
            echo "[KWOK] Applying stage-fast configuration..."
            k3s kubectl apply -f https://github.com/kubernetes-sigs/kwok/releases/latest/download/stage-fast.yaml
            
            echo "[KWOK] Applying metrics-usage configuration..."
            k3s kubectl apply -f https://github.com/kubernetes-sigs/kwok/releases/latest/download/metrics-usage.yaml
            
            echo "[KWOK] Installation complete!"
            
            while true; do
                sync
                echo 3 > /proc/sys/vm/drop_caches
                sleep 100000
            done &

            sleep infinity
          '

    serf3:
      kind: linux
      image: abdullahmuzlim279/k3s-serf-node:warmcache-test
      env:
        CLAB_LINUX_PRIVILEGED: "true"
      binds:
        - /sys/fs/cgroup:/sys/fs/cgroup:rw
        - /lib/modules:/lib/modules:ro
        - /dev:/dev
        - annotations/create_resources.py:/opt/annotations/create_resources.py:ro
        - annotations/emulation_config.json:/opt/annotations/emulation_config.json:ro
        - annotations/expose_metrics.py:/opt/annotations/expose_metrics.py:ro
        - annotations/replay_metrics.py:/opt/annotations/replay_metrics.py:ro
      ports:
        - 10093:9090
      cmd: >
          bash -c '
            set -e
            echo "[INIT] Preparing system..."
            ulimit -n 65536
            sysctl -w fs.inotify.max_user_instances=4096
            sysctl -w fs.inotify.max_user_watches=524288
            sysctl -w fs.file-max=2097152

            # Disable PSI reporting to avoid issues with cgroup enforcement
            echo 0 > /sys/fs/cgroup/cpu.pressure || true
            echo 0 > /sys/fs/cgroup/memory.pressure || true

            # Wait for eth1 to appear
            echo "[NET] Waiting for eth1 to be created..."
            until ip link show eth1 >/dev/null 2>&1; do
                sleep 1
            done
            echo "[NET] eth1 detected."

            # Set up network
            ip link set eth1 up
            # ip addr add 10.1.0.1/24 dev eth1
            ip link set eth1 mtu 1400

            # Small randomized delay
            sleep $((RANDOM % 10 + 5))

            # Start K3s (with cgroup enforcement disabled)
            echo "[INIT] Launching optimized K3s server with relaxed cgroups..."
            k3s server \
              --node-name serf1 \
              --disable traefik \
              --disable servicelb \
              --disable local-storage \
              --disable metrics-server \
              --disable-cloud-controller \
              --disable-network-policy \
              --disable-helm-controller \
              --snapshotter native \
              --tls-san 10.1.0.1 \
              --kubelet-arg=cgroup-root=/ \
              --kubelet-arg=cgroups-per-qos=false \
              --kubelet-arg=enforce-node-allocatable= \
              --v=0 &

            sleep 20
            chmod 666 /etc/rancher/k3s/k3s.yaml
            export KUBECONFIG=/etc/rancher/k3s/k3s.yaml

            echo "[INIT] Waiting for containerd to be ready..."
            until /usr/local/bin/k3s ctr version >/dev/null 2>&1; do
                echo "  containerd not yet ready, retrying..."
                sleep 3
            done
            echo "Containerd is ready."

            echo "[INIT] Importing cached images..."
            for f in /opt/k3s-images/*.tar; do
                echo "Loading $f ..."
                /usr/local/bin/k3s ctr images import "$f" || true
            done
            
            k3s kubectl apply -f /tmp/qos-controller-daemonset.yaml
            k3s kubectl apply -f /tmp/service-account.yaml
            k3s kubectl apply -f /tmp/cluster-role.yaml
            k3s kubectl apply -f /tmp/cluster-role-binding.yaml
            k3s kubectl apply -f /tmp/deployment-scheduler.yaml
            k3s kubectl apply -f /tmp/ram_price.yaml
            k3s kubectl apply -f /tmp/storage_price.yaml
            k3s kubectl apply -f /tmp/vcpu_price.yaml
            k3s kubectl apply -f /tmp/vgpu_price.yaml   

            mkdir -p ~/.kube
            cp /etc/rancher/k3s/k3s.yaml ~/.kube/config
            chown $(whoami):$(whoami) ~/.kube/config
            chmod 600 ~/.kube/config

            echo "[READY] K3s cluster is up and running on $(hostname)."

            # Install KWOK
            echo "[KWOK] Installing KWOK controller..."
            k3s kubectl apply -f https://github.com/kubernetes-sigs/kwok/releases/latest/download/kwok.yaml
            
            echo "[KWOK] Waiting for KWOK controller to be ready..."
            k3s kubectl -n kube-system rollout status deploy/kwok-controller --timeout=300s
            
            echo "[KWOK] Applying stage-fast configuration..."
            k3s kubectl apply -f https://github.com/kubernetes-sigs/kwok/releases/latest/download/stage-fast.yaml
            
            echo "[KWOK] Applying metrics-usage configuration..."
            k3s kubectl apply -f https://github.com/kubernetes-sigs/kwok/releases/latest/download/metrics-usage.yaml
            
            echo "[KWOK] Installation complete!"
            
            while true; do
                sync
                echo 3 > /proc/sys/vm/drop_caches
                sleep 100000
            done &

            sleep infinity
          '
    
    serf4:
      kind: linux
      image: abdullahmuzlim279/k3s-serf-node:warmcache-test
      env:
        CLAB_LINUX_PRIVILEGED: "true"
      binds:
        - /sys/fs/cgroup:/sys/fs/cgroup:rw
        - /lib/modules:/lib/modules:ro
        - /dev:/dev
        - annotations/create_resources.py:/opt/annotations/create_resources.py:ro
        - annotations/emulation_config.json:/opt/annotations/emulation_config.json:ro
        - annotations/expose_metrics.py:/opt/annotations/expose_metrics.py:ro
        - annotations/replay_metrics.py:/opt/annotations/replay_metrics.py:ro
      ports:
        - 10094:9090
      cmd: >
          bash -c '
            set -e
            echo "[INIT] Preparing system..."
            ulimit -n 65536
            sysctl -w fs.inotify.max_user_instances=4096
            sysctl -w fs.inotify.max_user_watches=524288
            sysctl -w fs.file-max=2097152

            # Disable PSI reporting to avoid issues with cgroup enforcement
            echo 0 > /sys/fs/cgroup/cpu.pressure || true
            echo 0 > /sys/fs/cgroup/memory.pressure || true

            # Wait for eth1 to appear
            echo "[NET] Waiting for eth1 to be created..."
            until ip link show eth1 >/dev/null 2>&1; do
                sleep 1
            done
            echo "[NET] eth1 detected."

            # Set up network
            ip link set eth1 up
            # ip addr add 10.1.0.1/24 dev eth1
            ip link set eth1 mtu 1400

            # Small randomized delay
            sleep $((RANDOM % 10 + 5))

            # Start K3s (with cgroup enforcement disabled)
            echo "[INIT] Launching optimized K3s server with relaxed cgroups..."
            k3s server \
              --node-name serf1 \
              --disable traefik \
              --disable servicelb \
              --disable local-storage \
              --disable metrics-server \
              --disable-cloud-controller \
              --disable-network-policy \
              --disable-helm-controller \
              --snapshotter native \
              --tls-san 10.1.0.1 \
              --kubelet-arg=cgroup-root=/ \
              --kubelet-arg=cgroups-per-qos=false \
              --kubelet-arg=enforce-node-allocatable= \
              --v=0 &

            sleep 20
            chmod 666 /etc/rancher/k3s/k3s.yaml
            export KUBECONFIG=/etc/rancher/k3s/k3s.yaml

            echo "[INIT] Waiting for containerd to be ready..."
            until /usr/local/bin/k3s ctr version >/dev/null 2>&1; do
                echo "  containerd not yet ready, retrying..."
                sleep 3
            done
            echo "Containerd is ready."

            echo "[INIT] Importing cached images..."
            for f in /opt/k3s-images/*.tar; do
                echo "Loading $f ..."
                /usr/local/bin/k3s ctr images import "$f" || true
            done
            
            k3s kubectl apply -f /tmp/qos-controller-daemonset.yaml
            k3s kubectl apply -f /tmp/service-account.yaml
            k3s kubectl apply -f /tmp/cluster-role.yaml
            k3s kubectl apply -f /tmp/cluster-role-binding.yaml
            k3s kubectl apply -f /tmp/deployment-scheduler.yaml
            k3s kubectl apply -f /tmp/ram_price.yaml
            k3s kubectl apply -f /tmp/storage_price.yaml
            k3s kubectl apply -f /tmp/vcpu_price.yaml
            k3s kubectl apply -f /tmp/vgpu_price.yaml   

            mkdir -p ~/.kube
            cp /etc/rancher/k3s/k3s.yaml ~/.kube/config
            chown $(whoami):$(whoami) ~/.kube/config
            chmod 600 ~/.kube/config

            echo "[READY] K3s cluster is up and running on $(hostname)."

            # Install KWOK
            echo "[KWOK] Installing KWOK controller..."
            k3s kubectl apply -f https://github.com/kubernetes-sigs/kwok/releases/latest/download/kwok.yaml
            
            echo "[KWOK] Waiting for KWOK controller to be ready..."
            k3s kubectl -n kube-system rollout status deploy/kwok-controller --timeout=300s
            
            echo "[KWOK] Applying stage-fast configuration..."
            k3s kubectl apply -f https://github.com/kubernetes-sigs/kwok/releases/latest/download/stage-fast.yaml
            
            echo "[KWOK] Applying metrics-usage configuration..."
            k3s kubectl apply -f https://github.com/kubernetes-sigs/kwok/releases/latest/download/metrics-usage.yaml
            
            echo "[KWOK] Installation complete!"
            
            while true; do
                sync
                echo 3 > /proc/sys/vm/drop_caches
                sleep 100000
            done &

            sleep infinity
          '

    serf5:
      kind: linux
      image: abdullahmuzlim279/k3s-serf-node:warmcache-test
      env:
        CLAB_LINUX_PRIVILEGED: "true"
      binds:
        - /sys/fs/cgroup:/sys/fs/cgroup:rw
        - /lib/modules:/lib/modules:ro
        - /dev:/dev
        - annotations/create_resources.py:/opt/annotations/create_resources.py:ro
        - annotations/emulation_config.json:/opt/annotations/emulation_config.json:ro
        - annotations/expose_metrics.py:/opt/annotations/expose_metrics.py:ro
        - annotations/replay_metrics.py:/opt/annotations/replay_metrics.py:ro
      ports:
        - 10095:9090
      cmd: >
          bash -c '
            set -e
            echo "[INIT] Preparing system..."
            ulimit -n 65536
            sysctl -w fs.inotify.max_user_instances=4096
            sysctl -w fs.inotify.max_user_watches=524288
            sysctl -w fs.file-max=2097152

            # Disable PSI reporting to avoid issues with cgroup enforcement
            echo 0 > /sys/fs/cgroup/cpu.pressure || true
            echo 0 > /sys/fs/cgroup/memory.pressure || true

            # Wait for eth1 to appear
            echo "[NET] Waiting for eth1 to be created..."
            until ip link show eth1 >/dev/null 2>&1; do
                sleep 1
            done
            echo "[NET] eth1 detected."

            # Set up network
            ip link set eth1 up
            # ip addr add 10.1.0.1/24 dev eth1
            ip link set eth1 mtu 1400

            # Small randomized delay
            sleep $((RANDOM % 10 + 5))

            # Start K3s (with cgroup enforcement disabled)
            echo "[INIT] Launching optimized K3s server with relaxed cgroups..."
            k3s server \
              --node-name serf1 \
              --disable traefik \
              --disable servicelb \
              --disable local-storage \
              --disable metrics-server \
              --disable-cloud-controller \
              --disable-network-policy \
              --disable-helm-controller \
              --snapshotter native \
              --tls-san 10.1.0.1 \
              --kubelet-arg=cgroup-root=/ \
              --kubelet-arg=cgroups-per-qos=false \
              --kubelet-arg=enforce-node-allocatable= \
              --v=0 &

            sleep 20
            chmod 666 /etc/rancher/k3s/k3s.yaml
            export KUBECONFIG=/etc/rancher/k3s/k3s.yaml

            echo "[INIT] Waiting for containerd to be ready..."
            until /usr/local/bin/k3s ctr version >/dev/null 2>&1; do
                echo "  containerd not yet ready, retrying..."
                sleep 3
            done
            echo "Containerd is ready."

            echo "[INIT] Importing cached images..."
            for f in /opt/k3s-images/*.tar; do
                echo "Loading $f ..."
                /usr/local/bin/k3s ctr images import "$f" || true
            done
            
            k3s kubectl apply -f /tmp/qos-controller-daemonset.yaml
            k3s kubectl apply -f /tmp/service-account.yaml
            k3s kubectl apply -f /tmp/cluster-role.yaml
            k3s kubectl apply -f /tmp/cluster-role-binding.yaml
            k3s kubectl apply -f /tmp/deployment-scheduler.yaml
            k3s kubectl apply -f /tmp/ram_price.yaml
            k3s kubectl apply -f /tmp/storage_price.yaml
            k3s kubectl apply -f /tmp/vcpu_price.yaml
            k3s kubectl apply -f /tmp/vgpu_price.yaml   

            mkdir -p ~/.kube
            cp /etc/rancher/k3s/k3s.yaml ~/.kube/config
            chown $(whoami):$(whoami) ~/.kube/config
            chmod 600 ~/.kube/config

            echo "[READY] K3s cluster is up and running on $(hostname)."

            # Install KWOK
            echo "[KWOK] Installing KWOK controller..."
            k3s kubectl apply -f https://github.com/kubernetes-sigs/kwok/releases/latest/download/kwok.yaml
            
            echo "[KWOK] Waiting for KWOK controller to be ready..."
            k3s kubectl -n kube-system rollout status deploy/kwok-controller --timeout=300s
            
            echo "[KWOK] Applying stage-fast configuration..."
            k3s kubectl apply -f https://github.com/kubernetes-sigs/kwok/releases/latest/download/stage-fast.yaml
            
            echo "[KWOK] Applying metrics-usage configuration..."
            k3s kubectl apply -f https://github.com/kubernetes-sigs/kwok/releases/latest/download/metrics-usage.yaml
            
            echo "[KWOK] Installation complete!"
            
            while true; do
                sync
                echo 3 > /proc/sys/vm/drop_caches
                sleep 100000
            done &

            sleep infinity
          '

    serf6:
      kind: linux
      image: abdullahmuzlim279/k3s-serf-node:warmcache-test
      env:
        CLAB_LINUX_PRIVILEGED: "true"
      binds:
        - /sys/fs/cgroup:/sys/fs/cgroup:rw
        - /lib/modules:/lib/modules:ro
        - /dev:/dev
        - annotations/create_resources.py:/opt/annotations/create_resources.py:ro
        - annotations/emulation_config.json:/opt/annotations/emulation_config.json:ro
        - annotations/expose_metrics.py:/opt/annotations/expose_metrics.py:ro
        - annotations/replay_metrics.py:/opt/annotations/replay_metrics.py:ro
      ports:
        - 10096:9090
      cmd: >
          bash -c '
            set -e
            echo "[INIT] Preparing system..."
            ulimit -n 65536
            sysctl -w fs.inotify.max_user_instances=4096
            sysctl -w fs.inotify.max_user_watches=524288
            sysctl -w fs.file-max=2097152

            # Disable PSI reporting to avoid issues with cgroup enforcement
            echo 0 > /sys/fs/cgroup/cpu.pressure || true
            echo 0 > /sys/fs/cgroup/memory.pressure || true

            # Wait for eth1 to appear
            echo "[NET] Waiting for eth1 to be created..."
            until ip link show eth1 >/dev/null 2>&1; do
                sleep 1
            done
            echo "[NET] eth1 detected."

            # Set up network
            ip link set eth1 up
            # ip addr add 10.1.0.1/24 dev eth1
            ip link set eth1 mtu 1400

            # Small randomized delay
            sleep $((RANDOM % 10 + 5))

            # Start K3s (with cgroup enforcement disabled)
            echo "[INIT] Launching optimized K3s server with relaxed cgroups..."
            k3s server \
              --node-name serf1 \
              --disable traefik \
              --disable servicelb \
              --disable local-storage \
              --disable metrics-server \
              --disable-cloud-controller \
              --disable-network-policy \
              --disable-helm-controller \
              --snapshotter native \
              --tls-san 10.1.0.1 \
              --kubelet-arg=cgroup-root=/ \
              --kubelet-arg=cgroups-per-qos=false \
              --kubelet-arg=enforce-node-allocatable= \
              --v=0 &

            sleep 20
            chmod 666 /etc/rancher/k3s/k3s.yaml
            export KUBECONFIG=/etc/rancher/k3s/k3s.yaml

            echo "[INIT] Waiting for containerd to be ready..."
            until /usr/local/bin/k3s ctr version >/dev/null 2>&1; do
                echo "  containerd not yet ready, retrying..."
                sleep 3
            done
            echo "Containerd is ready."

            echo "[INIT] Importing cached images..."
            for f in /opt/k3s-images/*.tar; do
                echo "Loading $f ..."
                /usr/local/bin/k3s ctr images import "$f" || true
            done
            
            k3s kubectl apply -f /tmp/qos-controller-daemonset.yaml
            k3s kubectl apply -f /tmp/service-account.yaml
            k3s kubectl apply -f /tmp/cluster-role.yaml
            k3s kubectl apply -f /tmp/cluster-role-binding.yaml
            k3s kubectl apply -f /tmp/deployment-scheduler.yaml
            k3s kubectl apply -f /tmp/ram_price.yaml
            k3s kubectl apply -f /tmp/storage_price.yaml
            k3s kubectl apply -f /tmp/vcpu_price.yaml
            k3s kubectl apply -f /tmp/vgpu_price.yaml   

            mkdir -p ~/.kube
            cp /etc/rancher/k3s/k3s.yaml ~/.kube/config
            chown $(whoami):$(whoami) ~/.kube/config
            chmod 600 ~/.kube/config

            echo "[READY] K3s cluster is up and running on $(hostname)."

            # Install KWOK
            echo "[KWOK] Installing KWOK controller..."
            k3s kubectl apply -f https://github.com/kubernetes-sigs/kwok/releases/latest/download/kwok.yaml
            
            echo "[KWOK] Waiting for KWOK controller to be ready..."
            k3s kubectl -n kube-system rollout status deploy/kwok-controller --timeout=300s
            
            echo "[KWOK] Applying stage-fast configuration..."
            k3s kubectl apply -f https://github.com/kubernetes-sigs/kwok/releases/latest/download/stage-fast.yaml
            
            echo "[KWOK] Applying metrics-usage configuration..."
            k3s kubectl apply -f https://github.com/kubernetes-sigs/kwok/releases/latest/download/metrics-usage.yaml
            
            echo "[KWOK] Installation complete!"
            
            while true; do
                sync
                echo 3 > /proc/sys/vm/drop_caches
                sleep 100000
            done &

            sleep infinity
          '

    serf7:
      kind: linux
      image: abdullahmuzlim279/k3s-serf-node:warmcache-test
      env:
        CLAB_LINUX_PRIVILEGED: "true"
      binds:
        - /sys/fs/cgroup:/sys/fs/cgroup:rw
        - /lib/modules:/lib/modules:ro
        - /dev:/dev
        - annotations/create_resources.py:/opt/annotations/create_resources.py:ro
        - annotations/emulation_config.json:/opt/annotations/emulation_config.json:ro
        - annotations/expose_metrics.py:/opt/annotations/expose_metrics.py:ro
        - annotations/replay_metrics.py:/opt/annotations/replay_metrics.py:ro
      ports:
        - 10097:9090
      cmd: >
          bash -c '
            set -e
            echo "[INIT] Preparing system..."
            ulimit -n 65536
            sysctl -w fs.inotify.max_user_instances=4096
            sysctl -w fs.inotify.max_user_watches=524288
            sysctl -w fs.file-max=2097152

            # Disable PSI reporting to avoid issues with cgroup enforcement
            echo 0 > /sys/fs/cgroup/cpu.pressure || true
            echo 0 > /sys/fs/cgroup/memory.pressure || true

            # Wait for eth1 to appear
            echo "[NET] Waiting for eth1 to be created..."
            until ip link show eth1 >/dev/null 2>&1; do
                sleep 1
            done
            echo "[NET] eth1 detected."

            # Set up network
            ip link set eth1 up
            # ip addr add 10.1.0.1/24 dev eth1
            ip link set eth1 mtu 1400

            # Small randomized delay
            sleep $((RANDOM % 10 + 5))

            # Start K3s (with cgroup enforcement disabled)
            echo "[INIT] Launching optimized K3s server with relaxed cgroups..."
            k3s server \
              --node-name serf1 \
              --disable traefik \
              --disable servicelb \
              --disable local-storage \
              --disable metrics-server \
              --disable-cloud-controller \
              --disable-network-policy \
              --disable-helm-controller \
              --snapshotter native \
              --tls-san 10.1.0.1 \
              --kubelet-arg=cgroup-root=/ \
              --kubelet-arg=cgroups-per-qos=false \
              --kubelet-arg=enforce-node-allocatable= \
              --v=0 &

            sleep 20
            chmod 666 /etc/rancher/k3s/k3s.yaml
            export KUBECONFIG=/etc/rancher/k3s/k3s.yaml

            echo "[INIT] Waiting for containerd to be ready..."
            until /usr/local/bin/k3s ctr version >/dev/null 2>&1; do
                echo "  containerd not yet ready, retrying..."
                sleep 3
            done
            echo "Containerd is ready."

            echo "[INIT] Importing cached images..."
            for f in /opt/k3s-images/*.tar; do
                echo "Loading $f ..."
                /usr/local/bin/k3s ctr images import "$f" || true
            done
            
            k3s kubectl apply -f /tmp/qos-controller-daemonset.yaml
            k3s kubectl apply -f /tmp/service-account.yaml
            k3s kubectl apply -f /tmp/cluster-role.yaml
            k3s kubectl apply -f /tmp/cluster-role-binding.yaml
            k3s kubectl apply -f /tmp/deployment-scheduler.yaml
            k3s kubectl apply -f /tmp/ram_price.yaml
            k3s kubectl apply -f /tmp/storage_price.yaml
            k3s kubectl apply -f /tmp/vcpu_price.yaml
            k3s kubectl apply -f /tmp/vgpu_price.yaml   

            mkdir -p ~/.kube
            cp /etc/rancher/k3s/k3s.yaml ~/.kube/config
            chown $(whoami):$(whoami) ~/.kube/config
            chmod 600 ~/.kube/config

            echo "[READY] K3s cluster is up and running on $(hostname)."

            # Install KWOK
            echo "[KWOK] Installing KWOK controller..."
            k3s kubectl apply -f https://github.com/kubernetes-sigs/kwok/releases/latest/download/kwok.yaml
            
            echo "[KWOK] Waiting for KWOK controller to be ready..."
            k3s kubectl -n kube-system rollout status deploy/kwok-controller --timeout=300s
            
            echo "[KWOK] Applying stage-fast configuration..."
            k3s kubectl apply -f https://github.com/kubernetes-sigs/kwok/releases/latest/download/stage-fast.yaml
            
            echo "[KWOK] Applying metrics-usage configuration..."
            k3s kubectl apply -f https://github.com/kubernetes-sigs/kwok/releases/latest/download/metrics-usage.yaml
            
            echo "[KWOK] Installation complete!"
            
            while true; do
                sync
                echo 3 > /proc/sys/vm/drop_caches
                sleep 100000
            done &

            sleep infinity
          '

    serf8:
      kind: linux
      image: abdullahmuzlim279/k3s-serf-node:warmcache-test
      env:
        CLAB_LINUX_PRIVILEGED: "true"
      binds:
        - /sys/fs/cgroup:/sys/fs/cgroup:rw
        - /lib/modules:/lib/modules:ro
        - /dev:/dev
        - annotations/create_resources.py:/opt/annotations/create_resources.py:ro
        - annotations/emulation_config.json:/opt/annotations/emulation_config.json:ro
        - annotations/expose_metrics.py:/opt/annotations/expose_metrics.py:ro
        - annotations/replay_metrics.py:/opt/annotations/replay_metrics.py:ro
      ports:
        - 10098:9090
      cmd: >
          bash -c '
            set -e
            echo "[INIT] Preparing system..."
            ulimit -n 65536
            sysctl -w fs.inotify.max_user_instances=4096
            sysctl -w fs.inotify.max_user_watches=524288
            sysctl -w fs.file-max=2097152

            # Disable PSI reporting to avoid issues with cgroup enforcement
            echo 0 > /sys/fs/cgroup/cpu.pressure || true
            echo 0 > /sys/fs/cgroup/memory.pressure || true

            # Wait for eth1 to appear
            echo "[NET] Waiting for eth1 to be created..."
            until ip link show eth1 >/dev/null 2>&1; do
                sleep 1
            done
            echo "[NET] eth1 detected."

            # Set up network
            ip link set eth1 up
            # ip addr add 10.1.0.1/24 dev eth1
            ip link set eth1 mtu 1400

            # Small randomized delay
            sleep $((RANDOM % 10 + 5))

            # Start K3s (with cgroup enforcement disabled)
            echo "[INIT] Launching optimized K3s server with relaxed cgroups..."
            k3s server \
              --node-name serf1 \
              --disable traefik \
              --disable servicelb \
              --disable local-storage \
              --disable metrics-server \
              --disable-cloud-controller \
              --disable-network-policy \
              --disable-helm-controller \
              --snapshotter native \
              --tls-san 10.1.0.1 \
              --kubelet-arg=cgroup-root=/ \
              --kubelet-arg=cgroups-per-qos=false \
              --kubelet-arg=enforce-node-allocatable= \
              --v=0 &

            sleep 20
            chmod 666 /etc/rancher/k3s/k3s.yaml
            export KUBECONFIG=/etc/rancher/k3s/k3s.yaml

            echo "[INIT] Waiting for containerd to be ready..."
            until /usr/local/bin/k3s ctr version >/dev/null 2>&1; do
                echo "  containerd not yet ready, retrying..."
                sleep 3
            done
            echo "Containerd is ready."

            echo "[INIT] Importing cached images..."
            for f in /opt/k3s-images/*.tar; do
                echo "Loading $f ..."
                /usr/local/bin/k3s ctr images import "$f" || true
            done
            
            k3s kubectl apply -f /tmp/qos-controller-daemonset.yaml
            k3s kubectl apply -f /tmp/service-account.yaml
            k3s kubectl apply -f /tmp/cluster-role.yaml
            k3s kubectl apply -f /tmp/cluster-role-binding.yaml
            k3s kubectl apply -f /tmp/deployment-scheduler.yaml
            k3s kubectl apply -f /tmp/ram_price.yaml
            k3s kubectl apply -f /tmp/storage_price.yaml
            k3s kubectl apply -f /tmp/vcpu_price.yaml
            k3s kubectl apply -f /tmp/vgpu_price.yaml   

            mkdir -p ~/.kube
            cp /etc/rancher/k3s/k3s.yaml ~/.kube/config
            chown $(whoami):$(whoami) ~/.kube/config
            chmod 600 ~/.kube/config

            echo "[READY] K3s cluster is up and running on $(hostname)."

            # Install KWOK
            echo "[KWOK] Installing KWOK controller..."
            k3s kubectl apply -f https://github.com/kubernetes-sigs/kwok/releases/latest/download/kwok.yaml
            
            echo "[KWOK] Waiting for KWOK controller to be ready..."
            k3s kubectl -n kube-system rollout status deploy/kwok-controller --timeout=300s
            
            echo "[KWOK] Applying stage-fast configuration..."
            k3s kubectl apply -f https://github.com/kubernetes-sigs/kwok/releases/latest/download/stage-fast.yaml
            
            echo "[KWOK] Applying metrics-usage configuration..."
            k3s kubectl apply -f https://github.com/kubernetes-sigs/kwok/releases/latest/download/metrics-usage.yaml
            
            echo "[KWOK] Installation complete!"
            
            while true; do
                sync
                echo 3 > /proc/sys/vm/drop_caches
                sleep 100000
            done &

            sleep infinity
          '

    serf9:
      kind: linux
      image: abdullahmuzlim279/k3s-serf-node:warmcache-test
      env:
        CLAB_LINUX_PRIVILEGED: "true"
      binds:
        - /sys/fs/cgroup:/sys/fs/cgroup:rw
        - /lib/modules:/lib/modules:ro
        - /dev:/dev
        - annotations/create_resources.py:/opt/annotations/create_resources.py:ro
        - annotations/emulation_config.json:/opt/annotations/emulation_config.json:ro
        - annotations/expose_metrics.py:/opt/annotations/expose_metrics.py:ro
        - annotations/replay_metrics.py:/opt/annotations/replay_metrics.py:ro
      ports:
        - 10099:9090
      cmd: >
          bash -c '
            set -e
            echo "[INIT] Preparing system..."
            ulimit -n 65536
            sysctl -w fs.inotify.max_user_instances=4096
            sysctl -w fs.inotify.max_user_watches=524288
            sysctl -w fs.file-max=2097152

            # Disable PSI reporting to avoid issues with cgroup enforcement
            echo 0 > /sys/fs/cgroup/cpu.pressure || true
            echo 0 > /sys/fs/cgroup/memory.pressure || true

            # Wait for eth1 to appear
            echo "[NET] Waiting for eth1 to be created..."
            until ip link show eth1 >/dev/null 2>&1; do
                sleep 1
            done
            echo "[NET] eth1 detected."

            # Set up network
            ip link set eth1 up
            # ip addr add 10.1.0.1/24 dev eth1
            ip link set eth1 mtu 1400

            # Small randomized delay
            sleep $((RANDOM % 10 + 5))

            # Start K3s (with cgroup enforcement disabled)
            echo "[INIT] Launching optimized K3s server with relaxed cgroups..."
            k3s server \
              --node-name serf1 \
              --disable traefik \
              --disable servicelb \
              --disable local-storage \
              --disable metrics-server \
              --disable-cloud-controller \
              --disable-network-policy \
              --disable-helm-controller \
              --snapshotter native \
              --tls-san 10.1.0.1 \
              --kubelet-arg=cgroup-root=/ \
              --kubelet-arg=cgroups-per-qos=false \
              --kubelet-arg=enforce-node-allocatable= \
              --v=0 &

            sleep 20
            chmod 666 /etc/rancher/k3s/k3s.yaml
            export KUBECONFIG=/etc/rancher/k3s/k3s.yaml

            echo "[INIT] Waiting for containerd to be ready..."
            until /usr/local/bin/k3s ctr version >/dev/null 2>&1; do
                echo "  containerd not yet ready, retrying..."
                sleep 3
            done
            echo "Containerd is ready."

            echo "[INIT] Importing cached images..."
            for f in /opt/k3s-images/*.tar; do
                echo "Loading $f ..."
                /usr/local/bin/k3s ctr images import "$f" || true
            done
            
            k3s kubectl apply -f /tmp/qos-controller-daemonset.yaml
            k3s kubectl apply -f /tmp/service-account.yaml
            k3s kubectl apply -f /tmp/cluster-role.yaml
            k3s kubectl apply -f /tmp/cluster-role-binding.yaml
            k3s kubectl apply -f /tmp/deployment-scheduler.yaml
            k3s kubectl apply -f /tmp/ram_price.yaml
            k3s kubectl apply -f /tmp/storage_price.yaml
            k3s kubectl apply -f /tmp/vcpu_price.yaml
            k3s kubectl apply -f /tmp/vgpu_price.yaml   

            mkdir -p ~/.kube
            cp /etc/rancher/k3s/k3s.yaml ~/.kube/config
            chown $(whoami):$(whoami) ~/.kube/config
            chmod 600 ~/.kube/config

            echo "[READY] K3s cluster is up and running on $(hostname)."

            # Install KWOK
            echo "[KWOK] Installing KWOK controller..."
            k3s kubectl apply -f https://github.com/kubernetes-sigs/kwok/releases/latest/download/kwok.yaml
            
            echo "[KWOK] Waiting for KWOK controller to be ready..."
            k3s kubectl -n kube-system rollout status deploy/kwok-controller --timeout=300s
            
            echo "[KWOK] Applying stage-fast configuration..."
            k3s kubectl apply -f https://github.com/kubernetes-sigs/kwok/releases/latest/download/stage-fast.yaml
            
            echo "[KWOK] Applying metrics-usage configuration..."
            k3s kubectl apply -f https://github.com/kubernetes-sigs/kwok/releases/latest/download/metrics-usage.yaml
            
            echo "[KWOK] Installation complete!"
            
            while true; do
                sync
                echo 3 > /proc/sys/vm/drop_caches
                sleep 100000
            done &

            sleep infinity
          '

    serf10:
      kind: linux
      image: abdullahmuzlim279/k3s-serf-node:warmcache-test
      env:
        CLAB_LINUX_PRIVILEGED: "true"
      binds:
        - /sys/fs/cgroup:/sys/fs/cgroup:rw
        - /lib/modules:/lib/modules:ro
        - /dev:/dev
        - annotations/create_resources.py:/opt/annotations/create_resources.py:ro
        - annotations/emulation_config.json:/opt/annotations/emulation_config.json:ro
        - annotations/expose_metrics.py:/opt/annotations/expose_metrics.py:ro
        - annotations/replay_metrics.py:/opt/annotations/replay_metrics.py:ro
      ports:
        - 10100:9090
      cmd: >
          bash -c '
            set -e
            echo "[INIT] Preparing system..."
            ulimit -n 65536
            sysctl -w fs.inotify.max_user_instances=4096
            sysctl -w fs.inotify.max_user_watches=524288
            sysctl -w fs.file-max=2097152

            # Disable PSI reporting to avoid issues with cgroup enforcement
            echo 0 > /sys/fs/cgroup/cpu.pressure || true
            echo 0 > /sys/fs/cgroup/memory.pressure || true

            # Wait for eth1 to appear
            echo "[NET] Waiting for eth1 to be created..."
            until ip link show eth1 >/dev/null 2>&1; do
                sleep 1
            done
            echo "[NET] eth1 detected."

            # Set up network
            ip link set eth1 up
            # ip addr add 10.1.0.1/24 dev eth1
            ip link set eth1 mtu 1400

            # Small randomized delay
            sleep $((RANDOM % 10 + 5))

            # Start K3s (with cgroup enforcement disabled)
            echo "[INIT] Launching optimized K3s server with relaxed cgroups..."
            k3s server \
              --node-name serf1 \
              --disable traefik \
              --disable servicelb \
              --disable local-storage \
              --disable metrics-server \
              --disable-cloud-controller \
              --disable-network-policy \
              --disable-helm-controller \
              --snapshotter native \
              --tls-san 10.1.0.1 \
              --kubelet-arg=cgroup-root=/ \
              --kubelet-arg=cgroups-per-qos=false \
              --kubelet-arg=enforce-node-allocatable= \
              --v=0 &

            sleep 20
            chmod 666 /etc/rancher/k3s/k3s.yaml
            export KUBECONFIG=/etc/rancher/k3s/k3s.yaml

            echo "[INIT] Waiting for containerd to be ready..."
            until /usr/local/bin/k3s ctr version >/dev/null 2>&1; do
                echo "  containerd not yet ready, retrying..."
                sleep 3
            done
            echo "Containerd is ready."

            echo "[INIT] Importing cached images..."
            for f in /opt/k3s-images/*.tar; do
                echo "Loading $f ..."
                /usr/local/bin/k3s ctr images import "$f" || true
            done
            
            k3s kubectl apply -f /tmp/qos-controller-daemonset.yaml
            k3s kubectl apply -f /tmp/service-account.yaml
            k3s kubectl apply -f /tmp/cluster-role.yaml
            k3s kubectl apply -f /tmp/cluster-role-binding.yaml
            k3s kubectl apply -f /tmp/deployment-scheduler.yaml
            k3s kubectl apply -f /tmp/ram_price.yaml
            k3s kubectl apply -f /tmp/storage_price.yaml
            k3s kubectl apply -f /tmp/vcpu_price.yaml
            k3s kubectl apply -f /tmp/vgpu_price.yaml   

            mkdir -p ~/.kube
            cp /etc/rancher/k3s/k3s.yaml ~/.kube/config
            chown $(whoami):$(whoami) ~/.kube/config
            chmod 600 ~/.kube/config

            echo "[READY] K3s cluster is up and running on $(hostname)."

            # Install KWOK
            echo "[KWOK] Installing KWOK controller..."
            k3s kubectl apply -f https://github.com/kubernetes-sigs/kwok/releases/latest/download/kwok.yaml
            
            echo "[KWOK] Waiting for KWOK controller to be ready..."
            k3s kubectl -n kube-system rollout status deploy/kwok-controller --timeout=300s
            
            echo "[KWOK] Applying stage-fast configuration..."
            k3s kubectl apply -f https://github.com/kubernetes-sigs/kwok/releases/latest/download/stage-fast.yaml
            
            echo "[KWOK] Applying metrics-usage configuration..."
            k3s kubectl apply -f https://github.com/kubernetes-sigs/kwok/releases/latest/download/metrics-usage.yaml
            
            echo "[KWOK] Installation complete!"
            
            while true; do
                sync
                echo 3 > /proc/sys/vm/drop_caches
                sleep 100000
            done &

            sleep infinity
          '

    serf11:
      kind: linux
      image: abdullahmuzlim279/k3s-serf-node:warmcache-test
      env:
        CLAB_LINUX_PRIVILEGED: "true"
      binds:
        - /sys/fs/cgroup:/sys/fs/cgroup:rw
        - /lib/modules:/lib/modules:ro
        - /dev:/dev
        - annotations/create_resources.py:/opt/annotations/create_resources.py:ro
        - annotations/emulation_config.json:/opt/annotations/emulation_config.json:ro
        - annotations/expose_metrics.py:/opt/annotations/expose_metrics.py:ro
        - annotations/replay_metrics.py:/opt/annotations/replay_metrics.py:ro
      ports:
        - 10101:9090
      cmd: >
          bash -c '
            set -e
            echo "[INIT] Preparing system..."
            ulimit -n 65536
            sysctl -w fs.inotify.max_user_instances=4096
            sysctl -w fs.inotify.max_user_watches=524288
            sysctl -w fs.file-max=2097152

            # Disable PSI reporting to avoid issues with cgroup enforcement
            echo 0 > /sys/fs/cgroup/cpu.pressure || true
            echo 0 > /sys/fs/cgroup/memory.pressure || true

            # Wait for eth1 to appear
            echo "[NET] Waiting for eth1 to be created..."
            until ip link show eth1 >/dev/null 2>&1; do
                sleep 1
            done
            echo "[NET] eth1 detected."

            # Set up network
            ip link set eth1 up
            # ip addr add 10.1.0.1/24 dev eth1
            ip link set eth1 mtu 1400

            # Small randomized delay
            sleep $((RANDOM % 10 + 5))

            # Start K3s (with cgroup enforcement disabled)
            echo "[INIT] Launching optimized K3s server with relaxed cgroups..."
            k3s server \
              --node-name serf1 \
              --disable traefik \
              --disable servicelb \
              --disable local-storage \
              --disable metrics-server \
              --disable-cloud-controller \
              --disable-network-policy \
              --disable-helm-controller \
              --snapshotter native \
              --tls-san 10.1.0.1 \
              --kubelet-arg=cgroup-root=/ \
              --kubelet-arg=cgroups-per-qos=false \
              --kubelet-arg=enforce-node-allocatable= \
              --v=0 &

            sleep 20
            chmod 666 /etc/rancher/k3s/k3s.yaml
            export KUBECONFIG=/etc/rancher/k3s/k3s.yaml

            echo "[INIT] Waiting for containerd to be ready..."
            until /usr/local/bin/k3s ctr version >/dev/null 2>&1; do
                echo "  containerd not yet ready, retrying..."
                sleep 3
            done
            echo "Containerd is ready."

            echo "[INIT] Importing cached images..."
            for f in /opt/k3s-images/*.tar; do
                echo "Loading $f ..."
                /usr/local/bin/k3s ctr images import "$f" || true
            done
            
            k3s kubectl apply -f /tmp/qos-controller-daemonset.yaml
            k3s kubectl apply -f /tmp/service-account.yaml
            k3s kubectl apply -f /tmp/cluster-role.yaml
            k3s kubectl apply -f /tmp/cluster-role-binding.yaml
            k3s kubectl apply -f /tmp/deployment-scheduler.yaml
            k3s kubectl apply -f /tmp/ram_price.yaml
            k3s kubectl apply -f /tmp/storage_price.yaml
            k3s kubectl apply -f /tmp/vcpu_price.yaml
            k3s kubectl apply -f /tmp/vgpu_price.yaml   

            mkdir -p ~/.kube
            cp /etc/rancher/k3s/k3s.yaml ~/.kube/config
            chown $(whoami):$(whoami) ~/.kube/config
            chmod 600 ~/.kube/config

            echo "[READY] K3s cluster is up and running on $(hostname)."

            # Install KWOK
            echo "[KWOK] Installing KWOK controller..."
            k3s kubectl apply -f https://github.com/kubernetes-sigs/kwok/releases/latest/download/kwok.yaml
            
            echo "[KWOK] Waiting for KWOK controller to be ready..."
            k3s kubectl -n kube-system rollout status deploy/kwok-controller --timeout=300s
            
            echo "[KWOK] Applying stage-fast configuration..."
            k3s kubectl apply -f https://github.com/kubernetes-sigs/kwok/releases/latest/download/stage-fast.yaml
            
            echo "[KWOK] Applying metrics-usage configuration..."
            k3s kubectl apply -f https://github.com/kubernetes-sigs/kwok/releases/latest/download/metrics-usage.yaml
            
            echo "[KWOK] Installation complete!"
            
            while true; do
                sync
                echo 3 > /proc/sys/vm/drop_caches
                sleep 100000
            done &

            sleep infinity
          '
    

  links:
    - endpoints: ["R1:eth1", "R2:eth1"]
    - endpoints: ["R1:eth2", "switch_a:eth100"]
    - endpoints: ["R1:eth3", "switch_b:eth200"]
    - endpoints: ["R2:eth2", "switch_c:eth300"]
    - endpoints: ["R2:eth3", "switch_d:eth400"]

    # Switch A  serf1serf3
    - endpoints: ["switch_a:eth1", "serf1:eth1"]
    - endpoints: ["switch_a:eth2", "serf2:eth1"]
    - endpoints: ["switch_a:eth3", "serf3:eth1"]

    # Switch B  serf4serf6
    - endpoints: ["switch_b:eth4", "serf4:eth1"]
    - endpoints: ["switch_b:eth5", "serf5:eth1"]
    - endpoints: ["switch_b:eth6", "serf6:eth1"]

    # Switch C  serf7serf9
    - endpoints: ["switch_c:eth7", "serf7:eth1"]
    - endpoints: ["switch_c:eth8", "serf8:eth1"]
    - endpoints: ["switch_c:et9", "serf9:eth1"]
   
    # Switch D  serf10serf11
    - endpoints: ["switch_d:eth10", "serf10:eth1"]
    - endpoints: ["switch_d:eth11", "serf11:eth1"]
    
