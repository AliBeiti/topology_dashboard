name: simple50

topology:
  nodes:
    switch_a:
      kind: ovs-bridge
    switch_b:
      kind: ovs-bridge
    switch_c:
      kind: ovs-bridge
    switch_d:
      kind: ovs-bridge
    switch_e:
      kind: ovs-bridge

    R1:
      kind: linux
      image: frrouting/frr:v7.5.1
      binds:
        - daemons:/etc/frr/daemons
        - r1.conf:/etc/frr/frr.conf

    R2:
      kind: linux
      image: frrouting/frr:v7.5.1
      binds:
        - daemons:/etc/frr/daemons
        - r2.conf:/etc/frr/frr.conf

    C1:
      kind: linux
      image: abdullahmuzlim279/k3s-serf-node:warmcache-test
      env:
        CLAB_LINUX_PRIVILEGED: "true"
      ports:
        - "9090:9090"
      binds:
        - /sys/fs/cgroup:/sys/fs/cgroup:rw
        - /lib/modules:/lib/modules:ro
        - /dev:/dev
      cmd: >
          bash -c '
            set -e
            echo "[INIT] Preparing system..."
            ulimit -n 65536
            sysctl -w fs.inotify.max_user_instances=4096
            sysctl -w fs.inotify.max_user_watches=524288
            sysctl -w fs.file-max=2097152

            # Disable PSI reporting to avoid issues with cgroup enforcement
            echo 0 > /sys/fs/cgroup/cpu.pressure || true
            echo 0 > /sys/fs/cgroup/memory.pressure || true

            # Wait for eth1 to appear
            echo "[NET] Waiting for eth1 to be created..."
            until ip link show eth1 >/dev/null 2>&1; do
                sleep 1
            done
            echo "[NET] eth1 detected."

            # Set up network
            ip link set eth1 up
            # ip addr add 10.1.0.1/24 dev eth1
            ip link set eth1 mtu 1400

            # Small randomized delay
            sleep $((RANDOM % 10 + 5))

            # Start K3s (with cgroup enforcement disabled)
            echo "[INIT] Launching optimized K3s server with relaxed cgroups..."
            k3s server \
              --node-name serf1 \
              --disable traefik \
              --disable servicelb \
              --disable local-storage \
              --disable metrics-server \
              --disable-cloud-controller \
              --disable-network-policy \
              --disable-helm-controller \
              --snapshotter native \
              --tls-san 10.1.0.1 \
              --kubelet-arg=cgroup-root=/ \
              --kubelet-arg=cgroups-per-qos=false \
              --kubelet-arg=enforce-node-allocatable= \
              --v=0 &

            sleep 20
            chmod 666 /etc/rancher/k3s/k3s.yaml
            export KUBECONFIG=/etc/rancher/k3s/k3s.yaml

            echo "[INIT] Waiting for containerd to be ready..."
            until /usr/local/bin/k3s ctr version >/dev/null 2>&1; do
                echo "  containerd not yet ready, retrying..."
                sleep 3
            done
            echo "Containerd is ready."

            echo "[INIT] Importing cached images..."
            for f in /opt/k3s-images/*.tar; do
                echo "Loading $f ..."
                /usr/local/bin/k3s ctr images import "$f" || true
            done
            
            k3s kubectl apply -f /tmp/qos-controller-daemonset.yaml
            k3s kubectl apply -f /tmp/service-account.yaml
            k3s kubectl apply -f /tmp/cluster-role.yaml
            k3s kubectl apply -f /tmp/cluster-role-binding.yaml
            k3s kubectl apply -f /tmp/deployment-scheduler.yaml
            k3s kubectl apply -f /tmp/ram_price.yaml
            k3s kubectl apply -f /tmp/storage_price.yaml
            k3s kubectl apply -f /tmp/vcpu_price.yaml
            k3s kubectl apply -f /tmp/vgpu_price.yaml   

            mkdir -p ~/.kube
            cp /etc/rancher/k3s/k3s.yaml ~/.kube/config
            chown $(whoami):$(whoami) ~/.kube/config
            chmod 600 ~/.kube/config

            echo "[READY] K3s cluster is up and running on $(hostname)."
            
            while true; do
                sync
                echo 3 > /proc/sys/vm/drop_caches
                sleep 100000
            done &

            sleep infinity
          '
    C2:
      kind: linux
      image: abdullahmuzlim279/k3s-serf-node:warmcache-test
      env:
        CLAB_LINUX_PRIVILEGED: "true"
      binds:
        - /sys/fs/cgroup:/sys/fs/cgroup:rw
        - /lib/modules:/lib/modules:ro
        - /dev:/dev
      cmd: >
          bash -c '
            set -e
            echo "[INIT] Preparing system..."
            ulimit -n 65536
            sysctl -w fs.inotify.max_user_instances=4096
            sysctl -w fs.inotify.max_user_watches=524288
            sysctl -w fs.file-max=2097152

            echo 0 > /sys/fs/cgroup/cpu.pressure || true
            echo 0 > /sys/fs/cgroup/memory.pressure || true

            echo "[NET] Waiting for eth1 to be created..."
            until ip link show eth1 >/dev/null 2>&1; do
                sleep 1
            done
            echo "[NET] eth1 detected."

            ip link set eth1 up
            # ip addr add 10.1.0.2/24 dev eth1
            ip link set eth1 mtu 1400

            sleep $((RANDOM % 10 + 5))

            echo "[INIT] Launching optimized K3s server with relaxed cgroups..."
            k3s server \
              --node-name serf2 \
              --disable traefik \
              --disable servicelb \
              --disable local-storage \
              --disable metrics-server \
              --disable-cloud-controller \
              --disable-network-policy \
              --disable-helm-controller \
              --snapshotter native \
              --tls-san 10.1.0.2 \
              --kubelet-arg=cgroup-root=/ \
              --kubelet-arg=cgroups-per-qos=false \
              --kubelet-arg=enforce-node-allocatable= \
              --v=0 &

            sleep 20
            chmod 666 /etc/rancher/k3s/k3s.yaml
            export KUBECONFIG=/etc/rancher/k3s/k3s.yaml

            echo "[INIT] Waiting for containerd to be ready..."
            until /usr/local/bin/k3s ctr version >/dev/null 2>&1; do
                echo "  containerd not yet ready, retrying..."
                sleep 3
            done
            echo "Containerd is ready."

            echo "[INIT] Importing cached images..."
            for f in /opt/k3s-images/*.tar; do
                echo "Loading $f ..."
                /usr/local/bin/k3s ctr images import "$f" || true
            done

            k3s kubectl apply -f /tmp/qos-controller-daemonset.yaml
            k3s kubectl apply -f /tmp/service-account.yaml
            k3s kubectl apply -f /tmp/cluster-role.yaml
            k3s kubectl apply -f /tmp/cluster-role-binding.yaml
            k3s kubectl apply -f /tmp/deployment-scheduler.yaml
            k3s kubectl apply -f /tmp/ram_price.yaml
            k3s kubectl apply -f /tmp/storage_price.yaml
            k3s kubectl apply -f /tmp/vcpu_price.yaml
            k3s kubectl apply -f /tmp/vgpu_price.yaml

            mkdir -p ~/.kube
            cp /etc/rancher/k3s/k3s.yaml ~/.kube/config
            chown $(whoami):$(whoami) ~/.kube/config
            chmod 600 ~/.kube/config

            echo "[READY] K3s cluster is up and running on $(hostname)."

            while true; do
                sync
                echo 3 > /proc/sys/vm/drop_caches
                sleep 100000
            done &

            sleep infinity
          '
    
    C3: {kind: linux, image: alpine:latest}
    C4: {kind: linux, image: alpine:latest}
    C5: {kind: linux, image: alpine:latest}
    C6: {kind: linux, image: alpine:latest}
    C7: {kind: linux, image: alpine:latest}
    C8: {kind: linux, image: alpine:latest}
    C9: {kind: linux, image: alpine:latest}
    C10: {kind: linux, image: alpine:latest}
    C11: {kind: linux, image: alpine:latest}
    C12: {kind: linux, image: alpine:latest}
    C13: {kind: linux, image: alpine:latest}
    C14: {kind: linux, image: alpine:latest}
    C15: {kind: linux, image: alpine:latest}
    C16: {kind: linux, image: alpine:latest}
    C17: {kind: linux, image: alpine:latest}
    C18: {kind: linux, image: alpine:latest}
    C19: {kind: linux, image: alpine:latest}
    C20: {kind: linux, image: alpine:latest}
    C21: {kind: linux, image: alpine:latest}
    C22: {kind: linux, image: alpine:latest}
    C23: {kind: linux, image: alpine:latest}
    C24: {kind: linux, image: alpine:latest}
    C25: {kind: linux, image: alpine:latest}
    C26: {kind: linux, image: alpine:latest}
    C27: {kind: linux, image: alpine:latest}
    C28: {kind: linux, image: alpine:latest}
    C29: {kind: linux, image: alpine:latest}
    C30: {kind: linux, image: alpine:latest}
    C31: {kind: linux, image: alpine:latest}
    C32: {kind: linux, image: alpine:latest}
    C33: {kind: linux, image: alpine:latest}
    C34: {kind: linux, image: alpine:latest}
    C35: {kind: linux, image: alpine:latest}
    C36: {kind: linux, image: alpine:latest}
    C37: {kind: linux, image: alpine:latest}
    C38: {kind: linux, image: alpine:latest}
    C39: {kind: linux, image: alpine:latest}
    C40: {kind: linux, image: alpine:latest}
    C41: {kind: linux, image: alpine:latest}
    C42: {kind: linux, image: alpine:latest}
    C43: {kind: linux, image: alpine:latest}
    C44: {kind: linux, image: alpine:latest}
    C45: {kind: linux, image: alpine:latest}
    C46: {kind: linux, image: alpine:latest}
    C47: {kind: linux, image: alpine:latest}
    C48: {kind: linux, image: alpine:latest}
    C49: {kind: linux, image: alpine:latest}
    C50: {kind: linux, image: alpine:latest}

  links:
    - endpoints: ["R1:eth1", "R2:eth1"]
    - endpoints: ["R1:eth2", "switch_a:eth100"]
    - endpoints: ["R1:eth3", "switch_b:eth200"]
    - endpoints: ["R2:eth2", "switch_c:eth300"]
    - endpoints: ["R2:eth3", "switch_d:eth400"]
    - endpoints: ["R2:eth4", "switch_e:eth500"]
    - endpoints: ["switch_a:eth1", "C1:eth1"]
    - endpoints: ["switch_a:eth2", "C2:eth1"]
    - endpoints: ["switch_a:eth3", "C3:eth1"]
    - endpoints: ["switch_a:eth4", "C4:eth1"]
    - endpoints: ["switch_a:eth5", "C5:eth1"]
    - endpoints: ["switch_a:eth6", "C6:eth1"]
    - endpoints: ["switch_a:eth7", "C7:eth1"]
    - endpoints: ["switch_a:eth8", "C8:eth1"]
    - endpoints: ["switch_a:eth9", "C9:eth1"]
    - endpoints: ["switch_a:eth10", "C10:eth1"]
    - endpoints: ["switch_b:eth11", "C11:eth1"]
    - endpoints: ["switch_b:eth12", "C12:eth1"]
    - endpoints: ["switch_b:eth13", "C13:eth1"]
    - endpoints: ["switch_b:eth14", "C14:eth1"]
    - endpoints: ["switch_b:eth15", "C15:eth1"]
    - endpoints: ["switch_b:eth16", "C16:eth1"]
    - endpoints: ["switch_b:eth17", "C17:eth1"]
    - endpoints: ["switch_b:eth18", "C18:eth1"]
    - endpoints: ["switch_b:eth19", "C19:eth1"]
    - endpoints: ["switch_b:eth20", "C20:eth1"]
    - endpoints: ["switch_c:eth21", "C21:eth1"]
    - endpoints: ["switch_c:eth22", "C22:eth1"]
    - endpoints: ["switch_c:eth23", "C23:eth1"]
    - endpoints: ["switch_c:eth24", "C24:eth1"]
    - endpoints: ["switch_c:eth25", "C25:eth1"]
    - endpoints: ["switch_c:eth26", "C26:eth1"]
    - endpoints: ["switch_c:eth27", "C27:eth1"]
    - endpoints: ["switch_c:eth28", "C28:eth1"]
    - endpoints: ["switch_c:eth29", "C29:eth1"]
    - endpoints: ["switch_c:eth30", "C30:eth1"]
    - endpoints: ["switch_d:eth31", "C31:eth1"]
    - endpoints: ["switch_d:eth32", "C32:eth1"]
    - endpoints: ["switch_d:eth33", "C33:eth1"]
    - endpoints: ["switch_d:eth34", "C34:eth1"]
    - endpoints: ["switch_d:eth35", "C35:eth1"]
    - endpoints: ["switch_d:eth36", "C36:eth1"]
    - endpoints: ["switch_d:eth37", "C37:eth1"]
    - endpoints: ["switch_d:eth38", "C38:eth1"]
    - endpoints: ["switch_d:eth39", "C39:eth1"]
    - endpoints: ["switch_d:eth40", "C40:eth1"]
    - endpoints: ["switch_e:eth41", "C41:eth1"]
    - endpoints: ["switch_e:eth42", "C42:eth1"]
    - endpoints: ["switch_e:eth43", "C43:eth1"]
    - endpoints: ["switch_e:eth44", "C44:eth1"]
    - endpoints: ["switch_e:eth45", "C45:eth1"]
    - endpoints: ["switch_e:eth46", "C46:eth1"]
    - endpoints: ["switch_e:eth47", "C47:eth1"]
    - endpoints: ["switch_e:eth48", "C48:eth1"]
    - endpoints: ["switch_e:eth49", "C49:eth1"]
    - endpoints: ["switch_e:eth50", "C50:eth1"]
